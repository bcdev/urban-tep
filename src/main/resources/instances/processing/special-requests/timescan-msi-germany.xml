<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>

<wps:Execute service="WPS"
             version="1.0.0"
             xmlns:wps="http://www.opengis.net/wps/1.0.0"
             xmlns:ows="http://www.opengis.net/ows/1.1"
             xmlns:xlink="http://www.w3.org/1999/xlink">

  <ows:Identifier>L3</ows:Identifier>

  <wps:DataInputs>

    <wps:Input>
      <ows:Identifier>productionName</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>TEP timescan msi Germany</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>processorBundleName</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>calvalus-landsat</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>processorBundleVersion</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>1.0</wps:LiteralData>
      </wps:Data>
    </wps:Input>

    <wps:Input>
      <ows:Identifier>inputPath</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>/calvalus/projects/urban-tep/msi-idepix-germany/L2_of_S2A_.*_V${yyyy}${MM}${dd}.*seq$</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>minDate</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>2015-06-01</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>maxDate</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>2017-03-31</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>periodLength</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>665</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>regionWKT</ows:Identifier>
         <wps:Data>
             <wps:LiteralData>POLYGON((5.98865807458 47.3024876979,5.98865807458 54.983104153115,15.0169958839 54.983104153115,15.0169958839 47.3024876979,5.98865807458 47.3024876979))</wps:LiteralData>
         </wps:Data>
    </wps:Input>

    <wps:Input>
      <ows:Identifier>calvalus.l3.parameters</ows:Identifier>
      <wps:Data>
        <wps:ComplexData>
          <parameters>
            <compositingType>MOSAICKING</compositingType>
            <planetaryGrid>org.esa.snap.binning.support.PlateCarreeGrid</planetaryGrid>
            <numRows>972000</numRows>
            <!-- <numRows>194400</numRows> -->
            <superSampling>1</superSampling>
            <maskExpr>! lc_invalid and ! lc_cloud</maskExpr>
            <variables>
              <variable>
                <name>ndbi</name>
                <expr>(B11 - B8A) / (B11 + B8A)</expr>
              </variable>
              <variable>
                <name>ndvi</name>
                <expr>(B8A - B4) / (B8A + B4)</expr>
              </variable>
              <variable>
                <name>mndwi</name>
                <expr>(B3 - B11) / (B3 + B11)</expr>
              </variable>
            </variables>
            <aggregators>
<!--
              <aggregator>
                <type>MIN_MAX</type>
                <varName>ndbi</varName>
              </aggregator>
-->
              <aggregator>
                <type>AVG</type>
                <varName>ndbi</varName>
              </aggregator>
              <aggregator>
                <type>PERCENTILE</type>
                <percentage>10</percentage>
                <varName>ndbi</varName>
              </aggregator>
              <aggregator>
                <type>PERCENTILE</type>
                <percentage>90</percentage>
                <varName>ndbi</varName>
              </aggregator>
<!--
              <aggregator>
                <type>MIN_MAX</type>
                <varName>ndvi</varName>
              </aggregator>
-->
              <aggregator>
                <type>AVG</type>
                <varName>ndvi</varName>
              </aggregator>
              <aggregator>
                <type>PERCENTILE</type>
                <percentage>10</percentage>
                <varName>ndvi</varName>
              </aggregator>
              <aggregator>
                <type>PERCENTILE</type>
                <percentage>90</percentage>
                <varName>ndvi</varName>
              </aggregator>
<!--
              <aggregator>
                <type>MIN_MAX</type>
                <varName>mndwi</varName>
              </aggregator>
-->
              <aggregator>
                <type>AVG</type>
                <varName>mndwi</varName>
              </aggregator>
              <aggregator>
                <type>PERCENTILE</type>
                <percentage>10</percentage>
                <varName>mndwi</varName>
              </aggregator>
              <aggregator>
                <type>PERCENTILE</type>
                <percentage>90</percentage>
                <varName>mndwi</varName>
              </aggregator>
            </aggregators>
          </parameters>
        </wps:ComplexData>
      </wps:Data>
    </wps:Input>

    <wps:Input>
      <ows:Identifier>calvalus.output.dir</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>/calvalus/projects/urban-tep/timescan-msi-germany-20m</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.output.format</ows:Identifier>
      <wps:Data>
<!--        <wps:LiteralData>BigGeoTiff</wps:LiteralData> -->
        <wps:LiteralData>NetCDF4</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.output.compression</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>none</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.output.prefix</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>timescan-msi-idepix-germany</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.output.postfix</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>-v4</wps:LiteralData>
      </wps:Data>
    </wps:Input>

<!--
    <wps:Input>
      <ows:Identifier>calvalus.ql.parameters</ows:Identifier>
      <wps:Data>
        <wps:ComplexData>
          <parameters>
            <quicklooks>
              <config>
                <subSamplingX>1</subSamplingX>
                <subSamplingY>1</subSamplingY>
                <RGBAExpressions>ndbi_max,ndvi_max,ndwi_mean,</RGBAExpressions>
                <imageType>png</imageType>
              </config>
              <config>
                <subSamplingX>1</subSamplingX>
                <subSamplingY>1</subSamplingY>
                <RGBAExpressions>ndbi_max,ndvi_max,mndwi_mean,</RGBAExpressions>
                <imageType>png</imageType>
              </config>
            </quicklooks>
          </parameters>
        </wps:ComplexData>
      </wps:Data>
    </wps:Input>
-->

    <wps:Input>
      <ows:Identifier>calvalus.resume</ows:Identifier>
      <wps:Data><wps:LiteralData>true</wps:LiteralData></wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.system.beam.pixelGeoCoding.useTiling</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>true</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.hadoop.mapreduce.job.queuename</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>tep</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.hadoop.mapreduce.map.maxattempts</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>2</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
      <ows:Identifier>calvalus.hadoop.mapreduce.map.failures.maxpercent</ows:Identifier>
      <wps:Data>
        <wps:LiteralData>5</wps:LiteralData>
      </wps:Data>
    </wps:Input>
    <wps:Input>
        <ows:Identifier>calvalus.hadoop.mapreduce.map.java.opts</ows:Identifier>
        <wps:Data><wps:LiteralData>-Djava.awt.headless=true -Xmx4096M -XX:ReservedCodeCacheSize=100m</wps:LiteralData></wps:Data>
    </wps:Input>
    <wps:Input>
        <ows:Identifier>calvalus.hadoop.mapreduce.map.memory.mb</ows:Identifier>
        <wps:Data><wps:LiteralData>5120</wps:LiteralData></wps:Data>
    </wps:Input>
    <wps:Input>
        <ows:Identifier>calvalus.hadoop.mapreduce.reduce.java.opts</ows:Identifier>
        <wps:Data><wps:LiteralData>-Djava.awt.headless=true -Xmx7168M -XX:ReservedCodeCacheSize=100m</wps:LiteralData></wps:Data>
    </wps:Input>
    <wps:Input>
        <ows:Identifier>calvalus.hadoop.mapreduce.reduce.memory.mb</ows:Identifier>
        <wps:Data><wps:LiteralData>8192</wps:LiteralData></wps:Data>
    </wps:Input>
  </wps:DataInputs>

</wps:Execute>
