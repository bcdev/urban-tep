#!/usr/bin/env python
__author__ = 'martin,uwe'

import time
import s2monitor
import traceback
import sys
from imonitor import IFile
from lxml.etree import XMLSyntaxError
from httplib import BadStatusLine
from httplib import IncompleteRead
from subprocess import CalledProcessError
from urllib2 import HTTPError

#srchost = 'scihub.copernicus.eu'
#srcroot = "/dhus/odata/v1/Products"
#srcroot = "/apihub/odata/v1/Products"
#srcuser = 'thomas.boettcher'
#srcuser = 'carstenbrockmann'

#srchost = 'cophub.copernicus.eu'
#srcroot = "/dhus/odata/v1/Products"
#srcuser = 'boettcher'

srchost = 'cophub.copernicus.eu'
srcroot = "/dhus/odata/v1/Products"
srcuser = 'boettcher'

srccursor = '2017-04-15T00:00:00.000Z/'
#srccursor = '2016-05-21T00:00:00.000Z/'
destroot = '/calvalus/eodata/S2_L1C/incoming'
execfile('.'+srcuser)

lakes = {
    'glass/Almasfuezito-and-Neszmely' : 'POLYGON((18.2712 47.7351,18.4028 47.7351,18.4028 47.7209,18.2712 47.7209,18.2712 47.7351))',
    'glass/Burdekin-Falls-Dam' : 'POLYGON((146.8851 -20.4657,147.1460 -20.4657,147.1460 -20.8320,146.8851 -20.8320,146.8851 -20.4657))',
    'glass/Frysian-Lakes' : 'POLYGON((5.3588 53.2530,6.2213 53.2530,6.2213 52.8335,5.3588 52.8335,5.3588 53.2530))',
    'glass/Hartbeespoort-Dam' : 'POLYGON((27.7948 -25.7126,27.9095 -25.7126,27.9095 -25.7772,27.7948 -25.7772,27.7948 -25.7126))',
    'glass/Himalayan-Lakes' : 'POLYGON((86.48 28.2,86.96 28.2,86.96 27.76,86.48 27.76,86.48 28.2))',
    'glass/Ijsselmeer' : 'POLYGON((4.9671 53.1085,5.7691 53.1085,5.7691 52.5208,4.9671 52.5208,4.9671 53.1085))',
    'glass/Lake-Arresoe' : 'POLYGON((12.0200 56.0202,12.1924 56.0202,12.1924 55.9346,12.0200 55.9346,12.0200 56.0202))',
    'glass/Lake-Balaton' : 'POLYGON((17.1908 47.1518,18.2414 47.1518,18.2414 46.6730,17.1908 46.6730,17.1908 47.1518))',
    'glass/Lake-Bogoria' : 'POLYGON((36.0609 0.3418,36.1362 0.3418,36.1362 0.1777,36.0609 0.1777,36.0609 0.3418))',
    'glass/Lake-Boyukshor' : 'POLYGON((49.8481 40.4761,49.9199 40.4761,49.9199 40.4258,49.8481 40.4258,49.8481 40.4761))',
    'glass/Lake-Chad' : 'POLYGON((12.9171 14.5403,15.2078 14.5403,15.2078 12.4358,12.9171 12.4358,12.9171 14.5403))',
    'glass/Lake-Constance' : 'POLYGON((8.7736 47.9240,9.8943 47.9240,9.8943 47.3672,8.7736 47.3672,8.7736 47.9240))',
    'glass/Lake-Garda' : 'POLYGON((10.3753 46.0218,11.1184 46.0218,11.1184 45.3202,10.3753 45.3202,10.3753 46.0218))',
    'glass/Lake-Lammin-Paeaejaervi' : 'POLYGON((24.50 60.83,25.83 60.83,25.83 61.33,24.50 61.33,24.50 60.83))',
    'glass/Lake-Maggiore' : 'POLYGON((8.1400 46.3169,9.0224 46.3169,9.0224 45.5977,8.1400 45.5977,8.1400 46.3169))',
    'glass/Lake-Malawi' : 'POLYGON((33.5632 -9.3625,35.8099 -9.3625,35.8099 -14.5092,33.5632 -14.5092,33.5632 -9.3625))',
    'glass/Lake-Maracaibo' : 'POLYGON((-72.1897 11.1063,-70.9579 11.1063,-70.9579 9.0064,-72.1897 9.0064,-72.1897 11.1063))',
    'glass/Lake-Mendota' : 'POLYGON((-89.4845 43.1540,-89.3660 43.1540,-89.3660 43.0703,-89.4845 43.0703,-89.4845 43.1540))',
    'glass/Lake-Nicaragua' : 'POLYGON((-86.0806 12.1715,-84.6990 12.1715,-84.6990 10.9566,-86.0806 10.9566,-86.0806 12.1715))',
    'glass/Lake-Paeijaenne' : 'POLYGON((25.1010 62.1497,25.9661 62.1497,25.9661 61.0879,25.1010 61.0879,25.1010 62.1497))',
    'glass/Lake-Peipsi' : 'POLYGON((27.0140 59.1360,28.1470 59.1360,28.1470 57.7640,27.0140 57.7640,27.0140 59.1360))',
    'glass/Lake-Simcoe' : 'POLYGON((-79.677 44.6245,-79.1441 44.6245,-79.1441 44.1980,-79.677 44.1980,-79.677 44.6245))',
    'glass/Lake-Taihu' : 'POLYGON((119.8756 30.9278,120.6056 30.9278,120.6056 31.5494,119.8756 31.5494 ,119.8756 30.9278))',
    'glass/Lake-Tana' : 'POLYGON((36.9813 12.3288,37.6810 12.3288,37.6810 11.5644,36.9813 11.5644,36.9813 12.3288))',
    'glass/Lake-Tanganyika' : 'POLYGON((28.6990 -3.1929,31.5032 -3.1929,31.5032 -8.9625,28.6990 -8.9625,28.6990 -3.1929))',
    'glass/Lake-Trasimeno' : 'POLYGON((12.0152 43.2021,12.2147 43.2021,12.2147 43.0707,12.0152 43.0707,12.0152 43.2021))',
    'glass/Lake-Uelemiste' : 'POLYGON((24.7293 59.4255,24.8018 59.4255,24.8018 59.3810,24.7293 59.3810,24.7293 59.4255))',
    'glass/Lake-Vaenern' : 'POLYGON((12.1004 59.3963,14.1659 59.3963,14.1659 58.3341,12.1004 58.3341,12.1004 59.3963))',
    'glass/Lake-Vaettern' : 'POLYGON((14.00210 58.8710,15.1007 58.8710,15.1007 57.7574,14.00210 57.7574,14.00210 58.8710))',
    'glass/Lake-Victoria' : 'POLYGON((31.2866 0.6319,34.9340 0.6319,34.9340 -2.9043,31.2866 -2.9043,31.2866 0.6319))',
    'glass/Lake-Voertsjaerv' : 'POLYGON((25.8759 58.4220,26.1975 58.4220,26.1975 58.0845,25.8759 58.0845,25.8759 58.4220))',
    'glass/Lake-Winnebago' : 'POLYGON((-88.5539 44.2549,-88.2669 44.2549,-88.2669 43.7946,-88.5539 43.7946,-88.5539 44.2549))',
    'glass/Lake-Zigh' : 'POLYGON((49.9848 40.3659,50.0122 40.3659,50.0122 40.3477,49.9848 40.3477,49.9848 40.3659))',
    'glass/Little-Wall-Lake' : 'POLYGON((-93.6437 42.2771,-93.6286 42.2771,-93.6286 42.2612,-93.6437 42.2612,-93.6437 42.2771))',
    'glass/Loskop-Dam-Lake' : 'POLYGON((29.2639 -25.4116,29.4205 -25.4116,29.4205 -25.4733,29.2639 -25.4733,29.2639 -25.4116))',
    'glass/Markermeer' : 'POLYGON((4.9850 52.6840,4.9850 52.3064,5.4560 52.3064,5.4560 52.6840,4.9850 52.6840))',
    'glass/Minnesota-Lakes' : 'POLYGON((-97.5805 49.6220,-90.6921 49.6220,-90.6921 43.3011,-97.5805 43.3011,-97.5805 49.6220))',
    'glass/Sivash-Sea' : 'POLYGON((33.5879 46.2595,34.4270 46.2595,34.4270 45.9673,33.5879 45.9673,33.5879 46.2595))',
    'glass/Theewaterskloof-Dam' : 'POLYGON((19.1246 -33.9806,19.3052 -33.9806,19.3052 -34.0851,19.1246 -34.0851,19.1246 -33.9806))',
    'glass/Paterswoldsemeer' : 'POLYGON((6.542702 53.187328,6.542702 53.154001,6.588020 53.154001,6.588020 53.187328,6.542702 53.187328))',
    'glass/Westeinderplassen' : 'POLYGON((4.671936 52.271543,4.671936 52.223197,4.762917 52.223197,4.762917 52.271543,4.671936 52.271543))',

    'sponge/Lake-Kasumigaura' : 'POLYGON((140.19254447483297 35.93760480114773, 140.51535821614715 35.93760480114773, 140.51535821614715 36.17611428915167, 140.19254447483297 36.17611428915167, 140.19254447483297 35.93760480114773))',
    'sponge/Zigi-River-at-Lanzoni' : 'POLYGON((38.753987168465166 -5.03385739636738, 38.84066086920986 -5.03385739636738, 38.84066086920986 -4.995816440543313, 38.753987168465166 -4.995816440543313, 38.753987168465166 -5.03385739636738))',
    'sponge/Ruvu-River-at-Mlandizi' : 'POLYGON((38.685171102224984 -6.749951909086365, 38.70635624626439 -6.749951909086365, 38.70635624626439 -6.685070303503159, 38.685171102224984 -6.685070303503159, 38.685171102224984 -6.749951909086365))',
    'sponge/Lake-Victoria-at-Bukoba' : 'POLYGON((31.669462031737737 -1.7367295736223733, 32.274933394961536 -1.7367295736223733, 32.274933394961536 -0.9084177629289585, 31.669462031737737 -0.9084177629289585, 31.669462031737737 -1.7367295736223733))',
#    'sponge/Lake-Victoria-at-South-Port' : 'POLYGON((31.573861290176094 -2.8829871583080924, 32.44223469269442 -2.8829871583080924, 32.44223469269442 -2.126876649590428, 31.573861290176094 -2.126876649590428, 31.573861290176094 -2.8829871583080924))',
    'sponge/Lake-Victoria-at-South-Port' : 'POLYGON ((31.441158396319423 -2.8430228289130612, 34.92126026947091 -2.8430228289130612, 34.92126026947091 0.5455111667272228, 31.441158396319423 0.5455111667272228, 31.441158396319423 -2.8430228289130612))',
    'sponge/Kagera-River-at-Nyakanyasi' : 'POLYGON((31.16066469679269 -1.2201790307903986, 31.247417623954835 -1.2201790307903986, 31.247417623954835 -1.1881786272784967, 31.16066469679269 -1.1881786272784967, 31.16066469679269 -1.2201790307903986))',
#    'sponge/Lake-Tanganyika-at-Kibirizi' : 'POLYGON((29.26351003576957 -5.16464317205527, 29.862010511587826 -5.16464317205527, 29.862010511587826 -4.5692956333570285, 29.26351003576957 -4.5692956333570285, 29.26351003576957 -5.16464317205527))',
    'sponge/Lake-Tanganyika-at-Kibirizi' : 'POLYGON((29.01243577905617 -8.885211845908644, 31.335033826821768 -8.885211845908644, 31.335033826821768 -3.240082549712029, 29.01243577905617 -3.240082549712029, 29.01243577905617 -8.885211845908644))',
    'sponge/Malagarasi-River-at-Mbelague' : 'POLYGON((30.03688538803318 -5.1963361381352025, 30.123717541612827 -5.1963361381352025, 30.123717541612827 -5.1706928531860425, 30.03688538803318 -5.1706928531860425, 30.03688538803318 -5.1963361381352025))',
    'sponge/Lake-Puruvesi' : 'POLYGON((29.216366992115162 61.71687389421, 29.823489254221112 61.71687389421, 29.823489254221112 62.061445766040265, 29.216366992115162 62.061445766040265, 29.216366992115162 61.71687389421))',
    'sponge/Lake-Lamposaarenselkae' : 'POLYGON((27.260242744180932 61.6043517476836, 27.354783476786633 61.6043517476836, 27.354783476786633 61.7023648445478, 27.260242744180932 61.7023648445478, 27.260242744180932 61.6043517476836))',
    'sponge/Lake-Vanajanselka' : 'POLYGON((23.756213101988518 61.07924559482455, 24.41154105137358 61.07924559482455, 24.41154105137358 61.28596364097238, 23.756213101988518 61.28596364097238, 23.756213101988518 61.07924559482455))',
    'sponge/Lake-Paeaejaervi-Syvaenne' : 'POLYGON((25.040094905636916 61.02385169114156, 25.227163446347454 61.02385169114156, 25.227163446347454 61.085670216887884, 25.040094905636916 61.085670216887884, 25.040094905636916 61.02385169114156))',
    'sponge/Lake-Pyhajarvi' : 'POLYGON((22.128290141627534 60.89073594056211, 22.431768939674683 60.89073594056211, 22.431768939674683 61.11640318341662, 22.128290141627534 61.11640318341662, 22.128290141627534 60.89073594056211))',
    'sponge/Lake-Ayarza' : 'POLYGON((-90.15341481233614 14.392816172713697, -90.08898160240415 14.392816172713697, -90.08898160240415 14.440418351836767, -90.15341481233614 14.440418351836767, -90.15341481233614 14.392816172713697))',
#    'sponge/Lake-Volta-at-Asikuma' : 'POLYGON((-0.8326940755500504 6.190915978770261, 0.3944410663331692 6.190915978770261, 0.3944410663331692 7.541725266714271, -0.8326940755500504 7.541725266714271, -0.8326940755500504 6.190915978770261))',
    'sponge/Lake-Volta-at-Asikuma' : 'POLYGON((-1.5221004501759035 6.172855126330909, 0.51103700094414 6.172855126330909, 0.51103700094414 8.91980636969998, -1.5221004501759035 8.91980636969998, -1.5221004501759035 6.172855126330909))',
    'sponge/Lake-Weija' : 'POLYGON((-0.40148212331352273 5.542303096197361, -0.3296520829087268 5.542303096197361, -0.3296520829087268 5.621172101370407, -0.40148212331352273 5.621172101370407, -0.40148212331352273 5.542303096197361))',
    'sponge/Barekese-Reservoir' : 'POLYGON((-1.7238596926965415 6.823822433251666, -1.6831685389379474 6.823822433251666, -1.6831685389379474 6.859536374457354, -1.7238596926965415 6.859536374457354, -1.7238596926965415 6.823822433251666))',
    'sponge/Lake-Bosomtwe' : 'POLYGON((-1.4505974624171614 6.461460520327019, -1.3652406375983606 6.461460520327019, -1.3652406375983606 6.543899270017895, -1.4505974624171614 6.543899270017895, -1.4505974624171614 6.461460520327019))',
    'sponge/River-Pra-at-Daboase' : 'POLYGON((-1.655949806781117 5.119881859881812, -1.6162928048367367 5.119881859881812, -1.6162928048367367 5.168111807410123, -1.655949806781117 5.168111807410123, -1.655949806781117 5.119881859881812))',
    'sponge/Lake-Izabal' : 'POLYGON((-89.44425098993003 15.338898434974801, -88.8068846276706 15.338898434974801, -88.8068846276706 15.809026484001265, -89.44425098993003 15.809026484001265, -89.44425098993003 15.338898434974801))',
    'sponge/Lake-Peten-Itza' : 'POLYGON((-89.99404229848439 16.894050092436792, -89.59651283140494 16.894050092436792, -89.59651283140494 17.030145497308155, -89.99404229848439 17.030145497308155, -89.99404229848439 16.894050092436792))',
    'sponge/Lake-Amatitlan-at-Amatitlan' : 'POLYGON((-90.61542857072699 14.405400651599281, -90.52356043072501 14.405400651599281, -90.52356043072501 14.497216456677691, -90.61542857072699 14.497216456677691, -90.61542857072699 14.405400651599281))',
    'sponge/Lake-Atitlan-Site-7' : 'POLYGON((-91.30022750895087 14.60252026492734, -91.10693744854727 14.60252026492734, -91.10693744854727 14.763101267271738, -91.30022750895087 14.763101267271738, -91.30022750895087 14.60252026492734))',
    'sponge/Reservoir-Armando-Ribeiro-Goncalves' : 'POLYGON((-37.02528708229571 -6.053971983650663, -36.76635672076583 -6.053971983650663, -36.76635672076583 -5.6311037234172545, -37.02528708229571 -5.6311037234172545, -37.02528708229571 -6.053971983650663))',
    'sponge/Lake-Geneva' : 'POLYGON ((6.078054785991413 46.19176379005328, 7.049801596982104 46.19176379005328, 7.049801596982104 46.57231308450886, 6.078054785991413 46.57231308450886, 6.078054785991413 46.19176379005328))',
    'sponge/Lake-Creteil' : 'POLYGON ((2.4442188268776412 48.76912822203287, 2.4603607323117034 48.76912822203287, 2.4603607323117034 48.78371679327928, 2.4442188268776412 48.78371679327928, 2.4442188268776412 48.76912822203287))',
    'sponge/Greifensee' : 'POLYGON ((8.641090042927063 47.314312013487324, 8.722245753670615 47.314312013487324, 8.722245753670615 47.37864452020949, 8.641090042927063 47.37864452020949, 8.641090042927063 47.314312013487324))',

    'c2x/S2_Gironde': 'POLYGON((-0.3768310882151127 45.817315080406246,-0.3768310882151127 44.84029065139799,-1.6402588225901127 44.84029065139799,-1.6402588225901127 45.817315080406246,-0.3768310882151127 45.817315080406246))',
    'c2x/S2_YellowRiverDelta': 'POLYGON((119.92346188053489 38.45789034424927,119.92346188053489 37.391981943533544,118.46777340397239 37.391981943533544,118.46777340397239 38.45789034424927,119.92346188053489 38.45789034424927))',
    'c2x/S2_AsovSea': 'POLYGON((39.55957017838955 47.3834738721015,39.55957017838955 44.933696389694674,34.61572252213955 44.933696389694674,34.61572252213955 47.3834738721015,39.55957017838955 47.3834738721015))',
    'c2x/S2_Belgium': 'POLYGON((3.8056639954447746 51.713416052417614,3.8056639954447746 50.81287701030896,0.15820305794477463 50.81287701030896,0.15820305794477463 51.713416052417614,3.8056639954447746 51.713416052417614))',
    'c2x/S2_RioDeLaPlata': 'POLYGON((-54.191162176430225 -33.897777013859475,-54.191162176430225 -37.04640889969956,-58.541748113930225 -37.04640889969956,-58.541748113930225 -33.897777013859475,-54.191162176430225 -33.897777013859475))',
    'c2x/S2_Ganges': 'POLYGON((92.51367174088955 23.221154981846556,92.51367174088955 20.673905264672843,87.19628892838955 20.673905264672843,87.19628892838955 23.221154981846556,92.51367174088955 23.221154981846556))',
    'c2x/S2_Kasimigaura': 'POLYGON((140.53546140901744 36.18665862660454,140.53546140901744 35.922420347285055,140.18939207307994 35.922420347285055,140.18939207307994 36.18665862660454,140.53546140901744 36.18665862660454))',

    'wadden_sea/SH_Watt': 'POLYGON((9.107666015625 55.11608453987681,9.107666015625 53.74221377343122,8.173828125 53.74221377343122,8.173828125 55.11608453987681,9.107666015625 55.11608453987681))',
    'wadden_sea/NDS_Watt': 'POLYGON((6.8994140625 53.80065082633023,8.4100341796875 53.80065082633023,8.4100341796875 53.35055131839989,6.8994140625 53.35055131839989,6.8994140625 53.80065082633023))',

    'ceos_sites/Railroad': 'POLYGON ((-115.72224502100593 38.519632459347584,-115.65388446194055 38.519632459347584,-115.65388446194055 38.48179170322274,-115.72168924410296 38.48179170322274,-115.72224502100593 38.519632459347584))',
    'ceos_sites/Frenchman': 'POLYGON ((-115.9477514993862 36.826023829481173,-115.90523456630893 36.826023829481173,-115.90523456630893 36.797101377702909,-115.9477514993862 36.797101377702909,-115.9477514993862 36.826023829481173))',
    'ceos_sites/Ivanpah': 'POLYGON ((-115.4578341594176 35.606206007433435,-115.33389591005515 35.606206007433435,-115.33389591005515 35.541110624742416,-115.45701406117044 35.540555351339862,-115.4578341594176 35.606206007433435))',
    'ceos_sites/LaCrau': 'POLYGON ((4.775606367825806 43.599298602027574,4.94289521561996 43.599298602027574,4.94289521561996 43.521166298821498,4.777829475437689 43.521166298821498,4.775606367825806 43.599298602027574))',
    'ceos_sites/Negev': 'POLYGON ((34.907606939280249 30.168613341022208,35.10879817815561 30.168613341022208,35.10879817815561 30.052264520892503,34.912053154504015 30.052264520892503,34.907606939280249 30.168613341022208))',
    'ceos_sites/Dunhuang': 'POLYGON ((94.289034360271813 40.153074769958792,94.387406872097628 40.153074769958792,94.387406872097628 40.102505490447648,94.289590137174798 40.102505490447648,94.289034360271813 40.153074769958792))',

    'germany': 'POLYGON((5.98865807458 47.3024876979,5.98865807458 54.983104153115,15.0169958839 54.983104153115,15.0169958839 47.3024876979,5.98865807458 47.3024876979))',

    'urban/sao_paulo': 'POLYGON((-47.41538061305751 -24.16080234326242,-47.41538061305751 -22.723497888671186,-45.84878717258703 -22.723497888671186,-45.84878717258703 -24.16080234326242,-47.41538061305751 -24.16080234326242))',  # T23KLP, T23KLQ
    'urban/mexico_city': 'POLYGON((-99.70900979233465 18.85122310111935,-99.70900979233465 20.198696027298624,-98.27933249282161 20.198696027298624,-98.27933249282161 18.85122310111935,-99.70900979233465 18.85122310111935))',  # T14QMG, T14QNG
    'urban/lagos': 'POLYGON((2.1058789021033513 5.819138620787439,2.1058789021033513 8.154758359498196,4.458968090389325 8.154758359498196,4.458968090389325 5.819138620787439,2.1058789021033513 5.819138620787439))',  # T31NEH
    'urban/ho_chi_minh': 'POLYGON((106.21001049932467 10.350689960784472,106.21001049932467 11.249005244904005,107.12452319208158 11.249005244904005,107.12452319208158 10.350689960784472,106.21001049932467 10.350689960784472))',  # T48PXS, T48PXT, T48PYS, T48PYT
    'urban/delhi': 'POLYGON((76.39266751207894 28.012949099044146,76.39266751207894 29.360422025223436,77.9286520679992 29.360422025223436,77.9286520679992 28.012949099044146,76.39266751207894 28.012949099044146))',  # T43RGM, T43RFM
    'urban/cairo': 'POLYGON((29.56115504481353 29.10019592687848,29.56115504481353 31.974804836060954,32.89844731114351 31.974804836060954,32.89844731114351 29.10019592687848,29.56115504481353 29.10019592687848))',  # T36RUU
    'urban/beijing': 'POLYGON((115.4 39.4,115.4 40.9,117.6 40.9,117.6 39.4,115.4 39.4))',  # T50TMK, T50SMK, T50SMJ, T50TNK, T50SNK, T50SNJ
    'urban/london': 'POLYGON((-0.516627355653 51.2668343542,-0.549537089505 51.6922328979,0.316005469631 51.7152155547,0.34091720084 51.2894714993,-0.516627355653 51.2668343542))',
#    'urban/basel': 'POLYGON((7.48819758224 47.6430273583,7.75444272578 47.6462273644,7.7589120672 47.4572936625,7.49362146702 47.4541146329,7.48819758224 47.6430273583))',
    'urban/heraklion': 'POLYGON((25.0262567394 35.2729181073,25.0239112268 35.3693421286,25.2230598463 35.3724357469,25.2251692997 35.276000774,25.0262567394 35.2729181073))',
}

im = s2monitor.S2Monitor('s2', srchost, srcuser, srcpassword, srcroot, lakes,
        srccursor=srccursor, destroot=destroot, destreplace=True,
        timemapping=('S2A_(OPER_PRD_MSIL1C_...._........T......_...._V|MSIL1C_........T......_....._...._T....._)(........)(.*)',
                     '\\2', '%Y%m%d', '/%Y/%m/%d/S2A_\\1\\2\\3'))

# initial query to get the cookie
query = "https://" + srchost + srcroot + "?$select=IngestionDate&$filter=substringof('S2A_MSIL1C_20161206T030112_N0204_R032_T50TML_20161206T030109',Name)"
while True:
    try:
        response = im._urlopen(query)
        break
    except (HTTPError, BadStatusLine) as e:
        print("waiting for initial retry ...")
        time.sleep(300)
xml = response.read()
print(xml)

i = im.iter(srccursor)
# for recovery of missed entries from that date on:
i._stack = [IFile(srccursor)]
p = None
c = 0
while True:
    try:
        if p is None:
            p = i.next()
            c = 0
        im.transfer(p)
        p = None
    except (IOError, OSError, XMLSyntaxError, BadStatusLine, IncompleteRead, CalledProcessError, HTTPError) as e:
        traceback.print_exc(file=sys.stdout)
        c += 1
        print("I/O error transferring {0} cycle {1}: {2}. sleeping ...".format(p, c, repr(e)))
        time.sleep(60)
        if c >= 5:
            c = 0
            p = None
#            i = im.iter()
        while True:
            try:
                im._cookie = None
                response = im._urlopen(query)
                break
            except (HTTPError, BadStatusLine) as e:
                print("waiting for initial retry after exception ...")
                time.sleep(300)

    except StopIteration:
        print('No more files found. sleeping ...')
        time.sleep(300)
        i = im.iter()

